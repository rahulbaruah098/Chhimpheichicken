{% extends "base.html" %}
{% block content %}
<h2>My Profile</h2>

<form method="post" class="card" style="padding:12px;max-width:600px">
  <label>Name</label>
  <input type="text" name="name" value="{{ user.name }}" required>
  <label>Email</label>
  <input type="email" value="{{ user.email }}" disabled>
  <label>Phone</label>
  <input type="text" name="phone" value="{{ user.phone or '' }}">
  <button class="btn" type="submit">Save Profile</button>
</form>

<h3 style="margin-top:24px">Addresses</h3>

<form method="post" action="{{ url_for('address_new') }}" class="card" style="padding:12px;max-width:600px">
  <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
    <strong>Add New Address</strong>
    <button type="button" class="btn-ghost" id="detectBtn">Detect Location</button>
  </div>
  <label>Label (Home/Work/etc)</label>
  <input type="text" name="label" placeholder="Home">
  <label>Address line 1</label>
  <input type="text" name="line1" required>
  <label>Address line 2</label>
  <input type="text" name="line2">
  <div class="row">
    <div class="col">
      <label>City</label>
      <input type="text" name="city">
    </div>
    <div class="col">
      <label>State</label>
      <input type="text" name="state">
    </div>
    <div class="col">
      <label>Pincode</label>
      <input type="text" name="pincode">
    </div>
  </div>
  <input type="hidden" name="latitude" id="lat">
  <input type="hidden" name="longitude" id="lng">
  <label style="display:flex;gap:8px;align-items:center">
    <input type="checkbox" name="is_default" value="1"> Set as default
  </label>
  <button class="btn" type="submit">Save Address</button>
</form>

<table class="table" style="margin-top:16px">
  <thead><tr><th>Label</th><th>Address</th><th>Coords</th><th>Default</th><th>Actions</th></tr></thead>
  <tbody>
    {% for a in addresses %}
    <tr>
      <td>{{ a.label }}</td>
      <td>
        {{ a.line1 }}{% if a.line2 %}, {{ a.line2 }}{% endif %},
        {{ a.city }}, {{ a.state }} {{ a.pincode }}
      </td>
      <td>
        {% if a.latitude and a.longitude %}
          {{ a.latitude }}, {{ a.longitude }}
        {% else %}
          <span class="muted">‚Äî</span>
        {% endif %}
      </td>
      <td>{{ 'Yes' if a.is_default else 'No' }}</td>
      <td style="display:flex;gap:8px">
        <form method="post" action="{{ url_for('address_delete', aid=a.id) }}">
          <button class="btn-ghost" onclick="return confirm('Delete this address?')">Delete</button>
        </form>
        {% if not a.is_default %}
        <form method="post" action="{{ url_for('address_set_default', aid=a.id) }} ">
          <button class="btn-ghost">Set Default</button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
(function(){
  const btn = document.getElementById('detectBtn');
  const latEl = document.getElementById('lat');
  const lngEl = document.getElementById('lng');

  function showHelp(message, detail){
    const tips = [
      '‚Ä¢ Make sure location services are ON at the OS level.',
      '‚Ä¢ In your browser, allow ‚ÄúLocation‚Äù for this site (padlock ‚Üí Site settings ‚Üí Location ‚Üí Allow).',
      '‚Ä¢ If you previously pressed ‚ÄúBlock‚Äù, clear that and try again.',
      '‚Ä¢ Disable VPN for a moment (it can confuse geolocation).',
    ].join('\n');
    alert(message + (detail ? (' ' + detail) : '') + '\n\nHow to fix:\n' + tips);
  }

  function getPositionOnce(opts){
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, opts);
    });
  }

  async function getIpFallback(){
    try{
      const res = await fetch('https://ipapi.co/json/', {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP error');
      const j = await res.json();
      if (j && typeof j.latitude === 'number' && typeof j.longitude === 'number'){
        return {lat:j.latitude, lng:j.longitude};
      }
    }catch(e){ return null; }
  }

  async function detect(){
    if (!btn) return;
    if (!('geolocation' in navigator)){
      const ip = await getIpFallback();
      if (ip){ latEl.value = ip.lat; lngEl.value = ip.lng; alert('Approximate location attached.'); }
      else{ showHelp('Geolocation not supported and IP lookup failed.'); }
      return;
    }

    try{
      const pos = await getPositionOnce({enableHighAccuracy:false, timeout:8000, maximumAge:0});
      latEl.value = pos.coords.latitude; lngEl.value = pos.coords.longitude;
      alert('Location attached to the address form.');
    }catch(e1){
      try{
        const pos2 = await getPositionOnce({enableHighAccuracy:true, timeout:15000, maximumAge:0});
        latEl.value = pos2.coords.latitude; lngEl.value = pos2.coords.longitude;
        alert('Location attached (high accuracy).');
      }catch(e2){
        const ip = await getIpFallback();
        if (ip){ latEl.value = ip.lat; lngEl.value = ip.lng; alert('Used approximate IP location.'); }
        else{ showHelp('Could not get location.', e2?.message ? `(${e2.message})` : ''); }
      }
    }
  }

  btn?.addEventListener('click', detect);
})();
</script>

<style>
/* ==========================================================
   PAGE-SCOPED THEME ‚Äî affects ONLY elements on this page.
   (No :root/body/h1/h2 globals; navbar/footer stay untouched.)
   ========================================================== */

/* Cards (only style .card elements on this page) */
.card{
  background:#ffffff !important;
  border:1px solid #e5e7eb !important;
  border-radius:14px !important;
  box-shadow:0 12px 28px rgba(2,6,23,.08);
  padding:18px !important;
  transition:box-shadow .2s ease, transform .15s ease;
}
.card:hover{ box-shadow:0 20px 40px rgba(2,6,23,.10); transform:translateY(-1px); }

/* Labels/Inputs inside our forms only */
form.card label{
  display:block; margin:.6rem 0 .35rem; color:#0f172a; font-weight:600;
}
form.card input[type="text"],
form.card input[type="email"],
form.card input[type="number"]{
  width:100%; padding:.75rem .9rem; border:1px solid #e5e7eb; border-radius:12px;
  background:#fff; color:#0f172a; font-weight:600; outline:none;
  transition:border-color .15s ease, box-shadow .15s ease, transform .06s ease;
}
form.card input[disabled]{ background:#f8fafc; color:#64748b; cursor:not-allowed; }
form.card input:focus{
  border-color:#16a34a;
  box-shadow:0 0 0 4px rgba(22,163,74,.18);
}
form.card input:active{ transform:scale(.995); }

/* Buttons: only our existing .btn / .btn-ghost buttons */
.btn{
  background:linear-gradient(90deg,#0ea5e9,#16a34a);
  border:none; color:#fff; padding:.9rem 1.1rem; border-radius:12px; font-weight:800;
  box-shadow:0 14px 32px rgba(22,163,74,.25);
  transition:transform .12s ease, box-shadow .2s ease, filter .15s ease;
}
.btn:hover{ transform:translateY(-1px); box-shadow:0 18px 40px rgba(22,163,74,.33); }
.btn:active{ transform:scale(.98); }
.btn[disabled]{ opacity:.6; cursor:not-allowed; }

.btn-ghost{
  background:#f1f5f9; color:#0f172a; border:1px solid #e5e7eb;
  padding:.55rem .85rem; border-radius:10px; font-weight:700;
  transition:background .15s ease, transform .12s ease, box-shadow .2s ease;
}
.btn-ghost:hover{ background:#eef2f7; transform:translateY(-1px); box-shadow:0 8px 20px rgba(2,6,23,.08); }
.btn-ghost:active{ transform:scale(.98); }

/* Row / Col grid only in the address form */
form[action*="address_new"] .row{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
form[action*="address_new"] .col{ min-width:0; }

/* Muted small text used in table coords dash */
.muted{ color:#64748b; }

/* Profile helper copy (scoped to the first .card form) */
form.card:first-of-type::before{
  content:"Keep your profile up to date to speed up checkout and service.";
  display:block; font-size:.9rem; color:#64748b; margin-bottom:8px;
}

/* Icons via ::before (only within this page‚Äôs forms) */
form.card:first-of-type label:first-of-type::before{ content:"üë§"; margin-right:8px; }
form.card:first-of-type label:nth-of-type(2)::before{ content:"‚úâÔ∏è"; margin-right:8px; }
form.card:first-of-type label:nth-of-type(3)::before{ content:"üìû"; margin-right:8px; }
#detectBtn::before{ content:"üìç"; margin-right:6px; }

/* Table styling (applies only to this .table) */
.table{
  width:100%; border-collapse:collapse; background:#ffffff;
  border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 12px 28px rgba(2,6,23,.08);
  overflow:hidden;
}
.table thead th{
  text-align:left; padding:14px 12px; background:#f8fafc; color:#0f172a; font-weight:800;
  border-bottom:1px solid #e5e7eb;
}
.table tbody td{
  padding:14px 12px; border-bottom:1px solid #f1f5f9; vertical-align:top; color:#0f172a;
}
.table tbody tr:hover{ background:#fcfcfc; }
.table tbody tr:last-child td{ border-bottom:none; }

/* Actions cell tidy alignment (scoped via inline style presence) */
.table tbody td[style*="display:flex"]{ align-items:center; }

/* Mobile-only adjustments for THIS table */
@media (max-width: 760px){
  form[action*="address_new"] .row{ grid-template-columns:1fr; }
  .table thead{ display:none; }
  .table, .table tbody, .table tr, .table td{ display:block; width:100%; }
  .table tr{
    background:#fff; border:1px solid #e5e7eb; border-radius:14px;
    box-shadow:0 12px 28px rgba(2,6,23,.08);
    padding:10px; margin:12px 0;
  }
  .table td{
    border:none; padding:8px 6px; display:flex; gap:10px; justify-content:space-between; align-items:flex-start;
  }
  .table tbody tr td:nth-child(1){ --label:"Label"; }
  .table tbody tr td:nth-child(2){ --label:"Address"; }
  .table tbody tr td:nth-child(3){ --label:"Coords"; }
  .table tbody tr td:nth-child(4){ --label:"Default"; }
  .table tbody tr td:nth-child(5){ --label:"Actions"; }
  .table td::before{
    content: var(--label);
    font-weight:700; color:#64748b; min-width:110px;
  }
}

/* A11y focus ring limited to inputs/buttons on THIS page */
form.card input:focus-visible,
.btn:focus-visible,
.btn-ghost:focus-visible,
#detectBtn:focus-visible{
  outline:3px solid rgba(22,163,74,.55);
  outline-offset:2px;
  border-radius:10px;
}

/* Gentle entrance animation for THIS page blocks */
.card, .table{ animation:profileFadeUp .28s ease both; }
@keyframes profileFadeUp{
  from{ opacity:0; transform:translateY(6px); }
  to{ opacity:1; transform:translateY(0); }
}
</style>
{% endblock %}
