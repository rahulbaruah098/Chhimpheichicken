{% extends "base.html" %}
{% block content %}
<!-- (Optional) If you keep this, ensure it doesn't also inject rows; our script avoids duplicates anyway -->
<script defer src="{{ url_for('static', filename='js/alerts.js') }}"></script>

<h2>Store Dashboard â€” {{ store.store_name }}</h2>

<!-- ðŸ”” New order alert sound -->
<audio id="ding" preload="auto">
  <source src="{{ url_for('static', filename='ding.mp3') }}" type="audio/mpeg">
</audio>

<!-- Enable Notification Button -->
<button id="enableSound" class="btn" style="margin:10px 0;background:#16a34a;color:white">
  ðŸ”” Enable Order Notifications
</button>

<!-- =====================
     Add Product
     ===================== -->
<h3>Add Product</h3>
<form method="post" action="{{ url_for('store_product_new') }}" class="form" enctype="multipart/form-data">
  <label>Name <input name="name" required></label>
  <label>Price per kg (â‚¹) <input name="price_per_kg" type="number" step="0.01" required></label>
  <label>Stock (kg) <input name="stock_kg" type="number" step="0.01" required></label>
  <label>Image (upload or capture)
    <input type="file" name="image" accept="image/*" capture="environment">
  </label>
  <button class="btn">Add</button>
</form>

<!-- =====================
     Product List
     ===================== -->
<h3>Products</h3>
<table class="table">
  <thead>
    <tr><th>Name</th><th>â‚¹/kg</th><th>Stock (kg)</th><th>Active</th><th>Image</th><th></th></tr>
  </thead>
  <tbody>
  {% for p in products %}
    <tr>
      <td>{{ p.name }}</td>
      <td>{{ '%.2f'|format(p.price_per_kg) }}</td>
      <td>{{ '%.2f'|format(p.stock_kg) }}</td>
      <td>{{ 'Yes' if p.is_active else 'No' }}</td>
      <td>{% if p.image_path %}<img class="thumb" src="/{{ p.image_path }}" alt="">{% endif %}</td>
      <td>
        <form method="post" action="{{ url_for('store_product_toggle', pid=p.id) }}">
          <button class="btn-ghost">Toggle Active</button>
        </form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<!-- =====================
     Orders
     ===================== -->
<h3>Orders</h3>
<table class="table">
  <thead>
    <tr>
      <th>#</th>
      <th>Customer</th>
      <th>Phone</th>
      <th>Total (â‚¹)</th>
      <th>Status</th>
      <th>Payment</th>
      <th>Deliver To</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="orders-list">
  {% for o in orders %}
    <!-- ðŸ‘‡ add created_at so JS can compute a safe initial "since" -->
    <tr data-order-id="{{ o.id }}" data-created-at="{{ o.created_at }}">
      <td>{{ o.id }}</td>
      <td>{{ o.customer_name }}</td>
      <td>{{ o.customer_phone or 'â€”' }}</td>
      <td>{{ '%.2f'|format(o.total_amount) }}</td>
      <td>{{ o.status }}</td>
      <td>{{ o.payment_status }}</td>
      <td class="muted">
        {% if o.addr_line1 %}
          {{ o.addr_line1 }}{% if o.addr_line2 %}, {{ o.addr_line2 }}{% endif %},
          {{ o.addr_city }}, {{ o.addr_state }} {{ o.addr_pincode }}
          {% if o.addr_lat and o.addr_lng %}<br><small>({{ o.addr_lat }}, {{ o.addr_lng }})</small>{% endif %}
        {% else %}
          â€”
        {% endif %}
        <div style="margin-top:6px">
          <a class="btn-ghost" href="{{ url_for('order_track', oid=o.id) }}">View items & track</a>
        </div>
      </td>
      <td style="min-width:260px">
        <div class="muted" style="margin:6px 0">
          Total Payable:
          <strong>â‚¹ {%
            set total_payable = (o.total_amount or 0) + (o.delivery_fee or 0) + (o.tip_amount or 0)
          %}{{ '%.2f'|format(total_payable) }}</strong>
          {% if o.tip_amount and o.tip_amount > 0 %}
            <span class="tag">includes tip â‚¹{{ '%.2f'|format(o.tip_amount) }}</span>
          {% endif %}
        </div>

        <form method="post" action="{{ url_for('store_order_status', oid=o.id) }}">
          <select name="status">
            <option {{ 'selected' if o.status=='PLACED' }}>PLACED</option>
            <option {{ 'selected' if o.status=='CONFIRMED' }}>CONFIRMED</option>
            <option {{ 'selected' if o.status=='OUT_FOR_DELIVERY' }}>OUT_FOR_DELIVERY</option>
            <option {{ 'selected' if o.status=='DELIVERED' }}>DELIVERED</option>
            <option {{ 'selected' if o.status=='CANCELLED' }}>CANCELLED</option>
          </select>
          <button class="btn">Update</button>
        </form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<!-- =====================
     Realtime alerts: init the poller for STORE role
     ===================== -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // If you still use an external poller, this just sets the role.
    if (window.initAlerts) {
      window.initAlerts({ role: 'store' });
    }

    const enableBtn = document.getElementById('enableSound');
    const ding = document.getElementById('ding');
    const tbody = document.getElementById('orders-list');

    // ---- Notifications button
    async function askNotif() {
      try {
        if ("Notification" in window && Notification.permission === "default") {
          await Notification.requestPermission();
        }
      } catch (e) {}
    }
    enableBtn.addEventListener('click', async () => {
      await askNotif();
      try { ding.currentTime = 0; await ding.play(); } catch (_) {}
      enableBtn.textContent = "ðŸ”” Notifications Enabled";
      enableBtn.disabled = true;
      enableBtn.style.opacity = "0.7";
    });

    // ---- Compute a SAFE initial "since" from the newest existing row
    function getInitialSinceISO() {
      let latest = null;
      tbody.querySelectorAll('tr[data-created-at]').forEach(tr => {
        const iso = tr.getAttribute('data-created-at');
        if (iso && (!latest || iso > latest)) latest = iso;
      });
      return latest || new Date().toISOString(); // start from "now" if none
    }
    let since = getInitialSinceISO();

    // ---- Helpers
    function rowExists(orderId) {
      return !!tbody.querySelector(`tr[data-order-id="${orderId}"]`);
    }
    function notify(title, body) {
      try {
        if ("Notification" in window && Notification.permission === "granted") {
          const n = new Notification(title, { body, icon: '{{ url_for("static", filename="favicon.ico") }}' });
          n.onclick = () => window.focus();
        }
      } catch (e) {}
      try { ding.currentTime = 0; ding.play(); } catch (e) {}
    }

    function htmlEscape(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}

    // Render a FULL row (same structure as server) so you can update status inline
    function renderFullOrderRow(o){
      const total_payable = (Number(o.total_amount||0)+Number(o.delivery_fee||0)+Number(o.tip_amount||0)).toFixed(2);
      const tipBadge = (o.tip_amount && Number(o.tip_amount) > 0)
        ? `<span class="tag">includes tip â‚¹${Number(o.tip_amount).toFixed(2)}</span>` : "";

      const addr = (o.addr_line1
            ? `${htmlEscape(o.addr_line1)}${o.addr_line2? ", "+htmlEscape(o.addr_line2):""}, ${htmlEscape(o.addr_city||"")}, ${htmlEscape(o.addr_state||"")} ${htmlEscape(o.addr_pincode||"")}`
            : "â€”");

      const latlng = (o.addr_lat!=null && o.addr_lng!=null)
            ? `<br><small>(${o.addr_lat}, ${o.addr_lng})</small>` : "";

      const tr = document.createElement('tr');
      tr.setAttribute('data-order-id', o.id);
      tr.setAttribute('data-created-at', o.created_at || new Date().toISOString());

      tr.innerHTML = `
        <td>${o.id}</td>
        <td>${htmlEscape(o.customer_name||"")}</td>
        <td>${htmlEscape(o.customer_phone||"â€”")}</td>
        <td>${Number(o.total_amount||0).toFixed(2)}</td>
        <td>${htmlEscape(o.status||"")}</td>
        <td>${htmlEscape(o.payment_status||"")}</td>
        <td class="muted">
          ${addr}
          ${latlng}
          <div style="margin-top:6px">
            <a class="btn-ghost" href="/orders/${o.id}">View items & track</a>
          </div>
        </td>
        <td style="min-width:260px">
          <div class="muted" style="margin:6px 0">
            Total Payable: <strong>â‚¹ ${total_payable}</strong> ${tipBadge}
          </div>
          <form method="post" action="/store/order/${o.id}/status">
            <select name="status">
              <option ${o.status==='PLACED'?'selected':''}>PLACED</option>
              <option ${o.status==='CONFIRMED'?'selected':''}>CONFIRMED</option>
              <option ${o.status==='OUT_FOR_DELIVERY'?'selected':''}>OUT_FOR_DELIVERY</option>
              <option ${o.status==='DELIVERED'?'selected':''}>DELIVERED</option>
              <option ${o.status==='CANCELLED'?'selected':''}>CANCELLED</option>
            </select>
            <button class="btn">Update</button>
          </form>
        </td>`;
      return tr;
    }

    async function fetchJSON(url){
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok) throw new Error('Network');
      return r.json();
    }

    // Poller: only INSERT if the order row does not already exist
    const POLL_MS = 5000;
    async function poll(){
      try{
        const res = await fetchJSON(`/api/alerts/store?since=${encodeURIComponent(since)}`);
        if(res.ok && Array.isArray(res.new) && res.new.length){
          // sort by created_at so 'since' can progress correctly
          res.new.sort((a,b)=>a.created_at.localeCompare(b.created_at));
          for(const n of res.new){
            const oid = n.order_id;
            // Skip if row already present (prevents duplicates you saw)
            if(rowExists(oid)) {
              if(n.created_at > since) since = n.created_at;
              continue;
            }

            // Try to fetch a detailed JSON for the order (if you've added such an endpoint)
            // Fallback: build a minimal object from what we have
            let order = null;
            try{
              const d = await fetchJSON(`/api/store/orders/${oid}`);
              if(d.ok) order = d.order;
            }catch(_){}

            if(!order){
              // minimal fallback so at least you see something (no duplication)
              order = {
                id: oid,
                created_at: n.created_at,
                total_amount: n.total_payable ?? n.total_amount ?? 0,
                delivery_fee: n.delivery_fee ?? 0,
                tip_amount: n.tip_amount ?? 0,
                status: 'PLACED',
                payment_status: 'PENDING',
                customer_name: 'New customer',
                customer_phone: 'â€”',
                addr_line1: '',
                addr_city: '',
                addr_state: '',
                addr_pincode: ''
              };
            }

            // Notify + insert row
            notify(`New Order #${order.id}`, `â‚¹${(Number(order.total_amount||0)+Number(order.delivery_fee||0)+Number(order.tip_amount||0)).toFixed(2)} â€” ${order.customer_name || ''}`);
            const tr = renderFullOrderRow(order);
            tbody.insertBefore(tr, tbody.firstChild);
            if(n.created_at > since) since = n.created_at;
          }
        }
      }catch(e){ /* ignore transient errors */ }
      setTimeout(poll, POLL_MS);
    }
    poll();
  });
</script>

<style>
.table img.thumb {
  width: 48px; height: 48px; object-fit: cover; border-radius: 8px;
}
.tag {
  background:#eee; color:#555; padding:2px 8px; border-radius:999px;
  font-size:.85rem;
}
</style>
{% endblock %}
